---
title: "Missing Data Infer"
output: html_document
---

```{r}
rm(list=ls());gc()
setwd("D:/UCSB/PSTAT296/Adjusting-Mortality-Curves-for-Rising-Opioid-Related-Deaths/Data/missing data")

library(tidyverse)
library(data.table)
library(lubridate) 
```



```{r}
main_data_5 <- read_csv("WONDER-SEX-5Yr-Cenus Division.csv")|> select(`Census Division Code`, `Sex Code`, `Five-Year Age Groups Code`, `Month Code`, Deaths)

```

```{r}
complete_death_panel_nogroup <- function(
  main_data,
  age_var     = NULL,
  start_month = "1999-01-01",
  end_month   = "2020-12-01",
  group_by_sex = TRUE
) {
  # 1) Decide which age column to use (honor whatever the data already uses)
  if (is.null(age_var)) {
    if ("Five-Year Age Groups Code" %in% names(main_data)) {
      age_var <- "Five-Year Age Groups Code"
    } else if ("Ten-Year Age Groups Code" %in% names(main_data)) {
      age_var <- "Ten-Year Age Groups Code"
    } else {
      age_var <- NULL
    }
  }

  # 2) Universes for each dimension
  census_divisions <- paste0("CENS-D", 1:9)
  sex_codes <- c("F", "M")

  age_groups_5yr <- c(
    "1", "5-9", "10-14", "15-19", "20-24", "25-29", "30-34", "35-39",
    "40-44", "45-49", "50-54", "55-59", "60-64", "65-69", "70-74",
    "75-79", "80-84", "85-89", "90-94", "95-99", "NS", "1-4", "100+"
  )

  age_groups_10yr <- c(
    "1", "1-4", "5-14", "15-24", "25-34", "35-44",
    "45-54", "55-64", "65-74", "75-84", "85+", "NS"
  )

  month_seq <- seq(
    lubridate::ymd(start_month),
    lubridate::ymd(end_month),
    by = "1 month"
  )
  month_codes <- paste0(format(month_seq, "%Y"), "/", format(month_seq, "%m"))

  # Choose which age levels to use in the completed panel
  if (!is.null(age_var)) {
    if (age_var == "Five-Year Age Groups Code") {
      age_levels <- age_groups_5yr
    } else if (age_var == "Ten-Year Age Groups Code") {
      age_levels <- age_groups_10yr
    } else {
      age_levels <- unique(as.character(main_data[[age_var]]))
    }
  } else {
    age_levels <- NULL
  }

  # 3) Clean incoming data (standardize names/types)
  main_data_clean <- main_data %>%
    dplyr::mutate(
      `Census Division Code` = as.character(`Census Division Code`),
      `Month Code`           = as.character(`Month Code`),
      Deaths                 = as.character(Deaths)
    )

  if ("Sex Code" %in% names(main_data_clean)) {
    main_data_clean <- main_data_clean %>%
      dplyr::mutate(`Sex Code` = as.character(`Sex Code`))
  }

  if (!is.null(age_var)) {
    main_data_clean <- main_data_clean %>%
      dplyr::mutate(`Age Group Code` = as.character(.data[[age_var]]))
  }

  # Keep only the columns used downstream
  keep_cols <- c("Census Division Code", "Month Code", "Deaths")
  if (!is.null(age_var)) keep_cols <- c(keep_cols, "Age Group Code")
  if ("Sex Code" %in% names(main_data_clean)) keep_cols <- c(keep_cols, "Sex Code")

  main_data_clean <- main_data_clean %>% dplyr::select(dplyr::any_of(keep_cols))

  # 4) If not grouping by sex, collapse across sexes (sum Deaths numerically; NAs treated as 0)
  if (!group_by_sex) {
    # If Sex Code missing, there's nothing to collapse
    if ("Sex Code" %in% names(main_data_clean)) {
      main_data_clean <- main_data_clean %>%
        dplyr::mutate(
          Deaths_num = suppressWarnings(as.numeric(Deaths)),
          Deaths_num = dplyr::if_else(is.na(Deaths_num), 0, Deaths_num)
        )

      group_vars <- c("Census Division Code", "Month Code")
      if (!is.null(age_var)) group_vars <- c(group_vars, "Age Group Code")

      main_data_clean <- main_data_clean %>%
        dplyr::group_by(dplyr::across(dplyr::all_of(group_vars))) %>%
        dplyr::summarise(Deaths = sum(Deaths_num, na.rm = TRUE), .groups = "drop") %>%
        dplyr::mutate(Deaths = as.character(Deaths))
    }

    # Ensure Sex Code is not present after collapsing
    main_data_clean <- main_data_clean %>% dplyr::select(-dplyr::any_of("Sex Code"))
  } else {
    # If grouping by sex is requested but Sex Code is missing, fall back to no-sex mode
    if (!("Sex Code" %in% names(main_data_clean))) {
      message("Sex Code column not found; proceeding without sex dimension.")
      group_by_sex <- FALSE
    }
  }

  # 5) Build the full grid to complete
  if (is.null(age_levels)) {
    if (group_by_sex) {
      all_combos <- tidyr::expand_grid(
        `Census Division Code` = census_divisions,
        `Sex Code`             = sex_codes,
        `Month Code`           = month_codes
      )
    } else {
      all_combos <- tidyr::expand_grid(
        `Census Division Code` = census_divisions,
        `Month Code`           = month_codes
      )
    }
  } else {
    if (group_by_sex) {
      all_combos <- tidyr::expand_grid(
        `Census Division Code` = census_divisions,
        `Sex Code`             = sex_codes,
        `Age Group Code`       = age_levels,
        `Month Code`           = month_codes
      )
    } else {
      all_combos <- tidyr::expand_grid(
        `Census Division Code` = census_divisions,
        `Age Group Code`       = age_levels,
        `Month Code`           = month_codes
      )
    }
  }

  # 6) Join to the grid and fill missing Deaths with "0"
  join_keys <- intersect(names(all_combos), names(main_data_clean))

  completed_data <- all_combos %>%
    dplyr::left_join(main_data_clean, by = join_keys) %>%
    dplyr::mutate(
      Deaths = dplyr::if_else(is.na(Deaths), "0", as.character(Deaths))
    )

  return(completed_data)
}


```


```{r}
WONDER_5Yr_Cenus_Region_Sex <- complete_death_panel_nogroup(
  main_data   = main_data_5,
  age_var     = "Five-Year Age Groups Code",
  start_month = "1999-01-01",
  end_month   = "2020-12-01"
) |>
  rename(`Five-Year Age Groups Code` = `Age Group Code`)



main_data_10 <-  read_csv("WONDER-SEX-10Yr-Cenus Division.csv") |> 
  select(`Census Division Code`, `Sex Code`, `Ten-Year Age Groups Code`, `Month Code`, Deaths) 


WONDER_10Yr_Cenus_Region_Sex<- complete_death_panel_nogroup(
  main_data = main_data_10,
  age_var     = "Ten-Year Age Groups Code",
  start_month = "1999-01-01",
  end_month   = "2020-12-01"
)|>
  rename(`Ten-Year Age Groups Code` = `Age Group Code`)

```


```{r, warning=F}


WONDER_10Yr_Cenus_Region_1999_2005 <- fread("Cenus Region Specific/WONDER-10Yr-Cenus Region-1999-2005.csv", fill = T)
WONDER_10Yr_Cenus_Region_2006_2010 <- fread("Cenus Region Specific/WONDER-10Yr-Cenus Region-2006-2010.csv", fill = T)
WONDER_10Yr_Cenus_Region_2011_2016 <- fread("Cenus Region Specific/WONDER-10Yr-Cenus Region-2011-2016.csv", fill = T)
WONDER_10Yr_Cenus_Region_2017_2020 <- fread("Cenus Region Specific/WONDER-10Yr-Cenus Region-2017-2020.csv", fill = T)


WONDER_5Yr_Cenus_Region_2017_2020 <- fread("Cenus Region Specific/WONDER-5Yr-Cenus Region-2017-2020.csv", fill = T)
WONDER_5Yr_Cenus_Region_2010_2016 <- fread("Cenus Region Specific/WONDER-5Yr-Cenus Region-2010-2016.csv", fill = T)
WONDER_5Yr_Cenus_Region_1999_2003 <- fread("Cenus Region Specific/WONDER-5Yr-Cenus Region-1999-2003.csv", fill = T)
WONDER_5Yr_Cenus_Region_2004_2009 <- fread("Cenus Region Specific/WONDER-5Yr-Cenus Region-2004-2009.csv", fill = T)


```

```{r}
WONDER_10Yr_Cenus_Region <- WONDER_10Yr_Cenus_Region_1999_2005 |>
  bind_rows(WONDER_10Yr_Cenus_Region_2006_2010,WONDER_10Yr_Cenus_Region_2011_2016,WONDER_10Yr_Cenus_Region_2017_2020)|>
  filter(!is.na(`Census Division Code`)) |> select(`Census Division Code`, `Month Code`, `Ten-Year Age Groups Code` ,`Deaths`)

WONDER_5Yr_Cenus_Region <- WONDER_5Yr_Cenus_Region_2017_2020 |>
  bind_rows(WONDER_5Yr_Cenus_Region_2010_2016,WONDER_5Yr_Cenus_Region_1999_2003,WONDER_5Yr_Cenus_Region_2004_2009) |>
  filter(!is.na(`Census Division Code`)) |> select(`Census Division Code`, `Month Code`, `Five-Year Age Groups Code` ,`Deaths`)



#All values are not suppressed
WONDER_Cenus_Region_Sex <- fread("Cenus Region Specific/WONDER-YM-Cenus Region-Sex-1999-2020.csv", fill = T) |> 
  select(`Census Division Code`, `Month Code`, `Sex Code` ,`Deaths`)


rm(
  WONDER_5Yr_Cenus_Region_2010_2016,WONDER_5Yr_Cenus_Region_1999_2003,
  WONDER_5Yr_Cenus_Region_2004_2009,WONDER_5Yr_Cenus_Region_2017_2020,
   WONDER_10Yr_Cenus_Region_2006_2010,WONDER_10Yr_Cenus_Region_2011_2016,
  WONDER_10Yr_Cenus_Region_2017_2020,WONDER_10Yr_Cenus_Region_1999_2005,
  main_data_10, main_data_5
  )
```




```{r}
library(dplyr)
library(tidyr)
library(purrr)
library(stringr)

#============================#
# 0) Helpers and normalization
#============================#

to_num_deaths <- function(x) {
  x <- as.character(x)
  out <- suppressWarnings(as.numeric(x))
  out[is.na(out) & x != "Suppressed"] <- NA_real_
  out
}

must_be_suppressed_1_to_9 <- function(x) {
  ifelse(!is.na(x) & x >= 1 & x <= 9 & abs(x - round(x)) < 1e-9,
         as.integer(round(x)), NA_integer_)
}

# Map 5-year ages into 10-year buckets
age_map <- tribble(
  ~Age5,   ~Age10,
  "1",     "1",
  "1-4",   "1-4",
  "5-9",   "5-14",
  "10-14", "5-14",
  "15-19", "15-24",
  "20-24", "15-24",
  "25-29", "25-34",
  "30-34", "25-34",
  "35-39", "35-44",
  "40-44", "35-44",
  "45-49", "45-54",
  "50-54", "45-54",
  "55-59", "55-64",
  "60-64", "55-64",
  "65-69", "65-74",
  "70-74", "65-74",
  "75-79", "75-84",
  "80-84", "75-84",
  "85-89", "85+",
  "90-94", "85+",
  "95-99", "85+",
  "100+",  "85+",
  "NS",    "NS"
)

# Standardize each of the five input frames
norm_5yr_sex <- function(df) {
  df %>%
    mutate(
      `Census Division Code` = as.character(`Census Division Code`),
      `Month Code`           = as.character(`Month Code`),
      `Sex Code`             = as.character(`Sex Code`),
      Age5                   = as.character(`Five-Year Age Groups Code`),
      Deaths_num             = to_num_deaths(Deaths),
      Deaths_chr             = as.character(Deaths)
    ) %>%
    left_join(age_map, by = "Age5") %>%
    mutate(
      was_suppressed = is.na(Deaths_num) & Deaths_chr == "Suppressed",
      fill_source    = NA_character_
    )
}

norm_5yr_total <- function(df) {
  df %>%
    mutate(
      `Census Division Code` = as.character(`Census Division Code`),
      `Month Code`           = as.character(`Month Code`),
      Age5                   = as.character(`Five-Year Age Groups Code`),
      Deaths_num_5tot        = to_num_deaths(Deaths)
    ) %>%
    select(`Census Division Code`,`Month Code`, Age5, Deaths_num_5tot)
}

norm_10yr_sex <- function(df) {
  df %>%
    mutate(
      `Census Division Code` = as.character(`Census Division Code`),
      `Month Code`           = as.character(`Month Code`),
      `Sex Code`             = as.character(`Sex Code`),
      Age10                  = as.character(`Ten-Year Age Groups Code`),
      Deaths_num             = to_num_deaths(Deaths)
    ) %>%
    select(`Census Division Code`,`Month Code`, Age10, `Sex Code`, Deaths_num)
}

norm_10yr_total <- function(df) {
  df %>%
    mutate(
      `Census Division Code` = as.character(`Census Division Code`),
      `Month Code`           = as.character(`Month Code`),
      Age10                  = as.character(`Ten-Year Age Groups Code`),
      Deaths_num_10tot       = to_num_deaths(Deaths)
    ) %>%
    select(`Census Division Code`,`Month Code`, Age10, Deaths_num_10tot)
}

norm_allages_sex <- function(df) {
  df %>%
    mutate(
      `Census Division Code` = as.character(`Census Division Code`),
      `Month Code`           = as.character(`Month Code`),
      `Sex Code`             = as.character(`Sex Code`),
      Deaths_num_sex_all     = to_num_deaths(Deaths)
    ) %>%
    select(`Census Division Code`,`Month Code`,`Sex Code`, Deaths_num_sex_all)
}

# Input data frames (as named in your environment):
# WONDER_5Yr_Cenus_Region_Sex
# WONDER_5Yr_Cenus_Region
# WONDER_10Yr_Cenus_Region_Sex
# WONDER_10Yr_Cenus_Region
# WONDER_Cenus_Region_Sex

w5sex <- norm_5yr_sex(WONDER_5Yr_Cenus_Region_Sex)
w5    <- norm_5yr_total(WONDER_5Yr_Cenus_Region)
w10s  <- norm_10yr_sex(WONDER_10Yr_Cenus_Region_Sex)
w10   <- norm_10yr_total(WONDER_10Yr_Cenus_Region)
wsex  <- norm_allages_sex(WONDER_Cenus_Region_Sex)

#=====================================#
# 1) Rule A: 5-year total = F + M
#=====================================#

wide_A <- w5sex %>%
  select(`Census Division Code`, `Month Code`, Age5, `Sex Code`, Deaths_num) %>%
  pivot_wider(names_from = `Sex Code`, values_from = Deaths_num)

wide_A <- wide_A %>%
  left_join(w5, by = c("Census Division Code","Month Code","Age5")) %>%
  mutate(
    fill_F = must_be_suppressed_1_to_9(ifelse(is.na(F) & !is.na(M) & !is.na(Deaths_num_5tot),
                                              Deaths_num_5tot - M, NA_real_)),
    fill_M = must_be_suppressed_1_to_9(ifelse(is.na(M) & !is.na(F) & !is.na(Deaths_num_5tot),
                                              Deaths_num_5tot - F, NA_real_))
  ) %>%
  pivot_longer(cols = c(F, M), names_to = "Sex Code", values_to = "Deaths_num") %>%
  mutate(candidate_fill = ifelse(`Sex Code`=="F", fill_F, fill_M)) %>%
  select(`Census Division Code`,`Month Code`, Age5, `Sex Code`, candidate_fill)

w5sex <- w5sex %>%
  left_join(wide_A, by = c("Census Division Code","Month Code","Age5","Sex Code")) %>%
  mutate(
    new_val    = ifelse(is.na(Deaths_num) & !is.na(candidate_fill), candidate_fill, NA_integer_),
    Deaths_num = ifelse(!is.na(new_val), new_val, Deaths_num),
    fill_source= ifelse(!is.na(new_val), "A_5yr_total_minus_other_sex", fill_source)
  ) %>%
  select(-candidate_fill, -new_val)

#================================================#
# 2) Enhance 10-yr-by-sex totals via 10-yr totals
#    (10yr_total = F10 + M10)
#================================================#

w10_enhanced_long <- w10s %>%
  pivot_wider(names_from = `Sex Code`, values_from = Deaths_num) %>%
  left_join(w10, by = c("Census Division Code","Month Code","Age10")) %>%
  mutate(
    fill_F = must_be_suppressed_1_to_9(ifelse(is.na(F) & !is.na(M) & !is.na(Deaths_num_10tot),
                                              Deaths_num_10tot - M, NA_real_)),
    fill_M = must_be_suppressed_1_to_9(ifelse(is.na(M) & !is.na(F) & !is.na(Deaths_num_10tot),
                                              Deaths_num_10tot - F, NA_real_)),
    F = ifelse(is.na(F) & !is.na(fill_F), fill_F, F),
    M = ifelse(is.na(M) & !is.na(fill_M), fill_M, M)
  ) %>%
  select(-Deaths_num_10tot, -fill_F, -fill_M) %>%
  pivot_longer(cols = c(F, M), names_to = "Sex Code", values_to = "Deaths_num_10sex_enh")

#=========================================================#
# 3) Rule B: inside each (Age10, Sex), if exactly one Age5
#    cell is missing, fill by subtraction.
#=========================================================#

w5sex <- w5sex %>%
  left_join(w10_enhanced_long,
            by = c("Census Division Code","Month Code","Age10","Sex Code"))

group_status <- w5sex %>%
  group_by(`Census Division Code`,`Month Code`, Age10, `Sex Code`) %>%
  summarise(
    grp_total_10sex = first(Deaths_num_10sex_enh),
    sum_known       = sum(Deaths_num, na.rm = TRUE),
    n_missing       = sum(is.na(Deaths_num)),
    .groups = "drop"
  ) %>%
  mutate(
    candidate_fill_group = must_be_suppressed_1_to_9(
      ifelse(!is.na(grp_total_10sex) & n_missing == 1,
             grp_total_10sex - sum_known, NA_real_)
    )
  )

w5sex <- w5sex %>%
  left_join(group_status %>%
              select(`Census Division Code`,`Month Code`, Age10, `Sex Code`, candidate_fill_group),
            by = c("Census Division Code","Month Code", "Age10","Sex Code")) %>%
  mutate(
    new_val    = ifelse(is.na(Deaths_num) & !is.na(candidate_fill_group),
                        candidate_fill_group, NA_integer_),
    Deaths_num = ifelse(!is.na(new_val), new_val, Deaths_num),
    fill_source= ifelse(!is.na(new_val) & is.na(fill_source),
                        "B_10yr_sex_total_minus_other_5yr", fill_source)
  ) %>%
  select(-candidate_fill_group, -new_val)

#=======================================================#
# 4) Rule D: last unknown across ages for a given (Sex,
#    Month, Region) using all-ages-by-sex totals
#=======================================================#

allages_status <- w5sex %>%
  group_by(`Census Division Code`,`Month Code`,`Sex Code`) %>%
  summarise(
    sum_known = sum(Deaths_num, na.rm = TRUE),
    n_missing = sum(is.na(Deaths_num)),
    .groups = "drop"
  ) %>%
  left_join(wsex, by = c("Census Division Code","Month Code","Sex Code")) %>%
  mutate(
    candidate_fill_allages = must_be_suppressed_1_to_9(
      ifelse(!is.na(Deaths_num_sex_all) & n_missing == 1,
             Deaths_num_sex_all - sum_known, NA_real_)
    )
  )

w5sex <- w5sex %>%
  left_join(allages_status %>% select(`Census Division Code`,`Month Code`,`Sex Code`,
                                     candidate_fill_allages),
            by = c("Census Division Code","Month Code","Sex Code")) %>%
  mutate(
    new_val    = ifelse(is.na(Deaths_num) & !is.na(candidate_fill_allages),
                        candidate_fill_allages, NA_integer_),
    Deaths_num = ifelse(!is.na(new_val), new_val, Deaths_num),
    fill_source= ifelse(!is.na(new_val) & is.na(fill_source),
                        "D_all_ages_sex_total_minus_other_ages", fill_source)
  ) %>%
  select(-candidate_fill_allages, -new_val)

#================================================#
# 5) One more quick cascade pass for A and B
#================================================#

iterate_once <- function(df, w5_totals) {
  # Rule A again
  wideA <- df %>%
    select(`Census Division Code`, `Month Code`, Age5, `Sex Code`, Deaths_num) %>%
    pivot_wider(names_from = `Sex Code`, values_from = Deaths_num) %>%
    left_join(w5_totals, by = c("Census Division Code","Month Code","Age5")) %>%
    mutate(
      fill_F = must_be_suppressed_1_to_9(ifelse(is.na(F) & !is.na(M) & !is.na(Deaths_num_5tot),
                                                Deaths_num_5tot - M, NA_real_)),
      fill_M = must_be_suppressed_1_to_9(ifelse(is.na(M) & !is.na(F) & !is.na(Deaths_num_5tot),
                                                Deaths_num_5tot - F, NA_real_))
    ) %>%
    pivot_longer(cols = c(F, M), names_to = "Sex Code", values_to = "Deaths_num") %>%
    mutate(candidate_fill = ifelse(`Sex Code`=="F", fill_F, fill_M)) %>%
    select(`Census Division Code`,`Month Code`, Age5, `Sex Code`, candidate_fill)

  df <- df %>%
    left_join(wideA, by = c("Census Division Code","Month Code","Age5","Sex Code")) %>%
    mutate(
      new_val    = ifelse(is.na(Deaths_num) & !is.na(candidate_fill), candidate_fill, NA_integer_),
      Deaths_num = ifelse(!is.na(new_val), new_val, Deaths_num),
      fill_source= ifelse(!is.na(new_val) & is.na(fill_source),
                          "A_5yr_total_minus_other_sex", fill_source)
    ) %>%
    select(-candidate_fill, -new_val)

  # Rule B again
  group_status2 <- df %>%
    group_by(`Census Division Code`,`Month Code`, Age10, `Sex Code`) %>%
    summarise(
      grp_total_10sex = first(Deaths_num_10sex_enh),
      sum_known       = sum(Deaths_num, na.rm = TRUE),
      n_missing       = sum(is.na(Deaths_num)),
      .groups = "drop"
    ) %>%
    mutate(
      candidate_fill_group = must_be_suppressed_1_to_9(
        ifelse(!is.na(grp_total_10sex) & n_missing == 1,
               grp_total_10sex - sum_known, NA_real_)
      )
    )

  df %>%
    left_join(group_status2 %>%
                select(`Census Division Code`,`Month Code`, Age10, `Sex Code`, candidate_fill_group),
              by = c("Census Division Code","Month Code","Age10","Sex Code")) %>%
    mutate(
      new_val    = ifelse(is.na(Deaths_num) & !is.na(candidate_fill_group),
                          candidate_fill_group, NA_integer_),
      Deaths_num = ifelse(!is.na(new_val), new_val, Deaths_num),
      fill_source= ifelse(!is.na(new_val) & is.na(fill_source),
                          "B_10yr_sex_total_minus_other_5yr", fill_source)
    ) %>%
    select(-candidate_fill_group, -new_val)
}

w5sex <- iterate_once(w5sex, w5)

#=====================================#
# 6) Final output and summary
#=====================================#

WONDER_5Yr_Cenus_Region_Sex_filled <- w5sex %>%
  mutate(
    Deaths_final = ifelse(!is.na(Deaths_num), as.character(Deaths_num), Deaths_chr)
  ) %>%
  select(`Census Division Code`,`Month Code`, Age5, Age10,
         `Sex Code`, Deaths = Deaths_final, fill_source, was_suppressed)

filled_rows <- WONDER_5Yr_Cenus_Region_Sex_filled %>%
  filter(was_suppressed, Deaths != "Suppressed")

fill_summary <- filled_rows %>%
  count(fill_source, name = "n_filled") %>%
  arrange(desc(n_filled))

print(fill_summary)
cat("\nTotal suppressed cells inferred with certainty: ",
    sum(fill_summary$n_filled), "\n", sep = "")


label <- read_csv("WONDER-SEX-5Yr-Cenus Division.csv", show_col_types = F)|> 
  select(`Census Division Code`, `Census Division`, `Five-Year Age Groups Code`, `Five-Year Age Groups`) |> unique()


final_data <- WONDER_5Yr_Cenus_Region_Sex_filled |> select(-Age10, - fill_source, -was_suppressed) |> 
  rename("Five-Year Age Groups Code" = Age5) |> 
  left_join(label, by= join_by(`Five-Year Age Groups Code`, `Census Division Code`))

final_data |> write_csv("WONDER-SEX-5Yr-Cenus Division-Cleaned.csv")
```


