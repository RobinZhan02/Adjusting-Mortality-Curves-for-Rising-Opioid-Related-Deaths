---
title: "Wonder Time Series"
output: html_document
---

```{r message=FALSE}
library(dplyr)
library(ggplot2)
library(stringr)
library(readxl)
library(forecast)
library(lubridate)
library(tseries)
library(strucchange)
library(purrr)
```

## All Deaths

```{r}
year_month <- read.csv("../data/time_series/WONDER-YearMonth.csv") %>%
  filter(Notes != "Total" & Year != "NA") %>%
  mutate(Date = as.Date(paste0(Month.Code, "/01"), format = "%Y/%m/%d"))

plot(year_month$Date, year_month$Deaths, type = "l",
     xlab = "Date", ylab = "# of Deaths", main = "Opioid-Related Death Counts Over Time")
```

```{r}
breakpoints(Deaths ~ Date, data = year_month, breaks = 1)
```


```{r}
pre <- year_month %>% filter(Year < 2014)
post <- year_month %>% filter(Year >= 2014)

acf(diff(pre$Deaths), lag.max = 36)
acf(diff(post$Deaths, differences = 2), lag.max = 36)
```

```{r}
six_month <- year_month %>%
  mutate(group6 = ceiling(row_number() / 6)) %>%
  group_by(group6) %>%
  summarise(
    start_date = first(Date),
    deaths_6mo = sum(Deaths)
  ) %>%
  mutate(
    total_deaths = sum(deaths_6mo),
    lambda_6mo = deaths_6mo / total_deaths,
    fitted_6mo = lambda_6mo * total_deaths
  )

ggplot() +
  geom_line(data = year_month, aes(x = Date, y = Deaths),
            color = "black", size = 1, alpha = 0.8) +
  geom_step(data = six_month, aes(x = start_date, y = fitted_6mo/6),
            color = "blue", size = 0.8) +
  labs(
    title = "Original Monthly Deaths vs 6-Month Fitted Intensity Model",
    y = "Deaths", x = "Date"
  ) +
  theme_minimal()
```

```{r}
twelve_month <- year_month %>%
  mutate(group12 = ceiling(row_number() / 12)) %>%
  group_by(group12) %>%
  summarise(
    start_date = first(Date),
    deaths_12mo = sum(Deaths)
  ) %>%
  mutate(
    total_deaths = sum(deaths_12mo),
    lambda_12mo = deaths_12mo / total_deaths,
    fitted_12mo = lambda_12mo * total_deaths
  )

ggplot() +
  geom_line(data = year_month, aes(x = Date, y = Deaths),
            color = "black", size = 1, alpha = 0.8) +
  geom_step(data = twelve_month, aes(x = start_date, y = fitted_12mo/12),
            color = "red", size = 0.8) +
  labs(
    title = "Original Monthly Deaths vs 12-Month Fitted Intensity Model",
    y = "Deaths", x = "Date"
  ) +
  theme_minimal()
```